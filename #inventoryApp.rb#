require 'sinatra'
require 'sinatra/reloader'
require 'sinatra/activerecord'
require 'securerandom'
require './models/user'
require './models/item'

enable :sessions
set :session_secret, SecureRandom.hex(64)
set :database, { adapter: "sqlite3", database: "db/mydb.sqlite" }

puts "Connected to: #{ActiveRecord::Base.connection_db_config.database}"

helpers do
  def require_login!
    redirect '/login?message=Please+log+in+first.' unless session[:user_id]
  end
end

get '/' do
    @message = params[:message]
    if session[:user_id]
        user = User.find_by(id: session[:user_id])
        @welcome = "Welcome #{user.username}! This is an Inventory System."
    else
        @welcome = "Welcome to the Inventory System!"
    end
    erb :index
end


get '/view' do
    @message = params[:message]
    @items = Item.all
    erb :view
end

get '/add' do
    require_login!
    @message = params[:message]
    erb :add
end

post '/add' do
    require_login!
    normalized_item = params[:item].strip.upcase
    quantity = params[:quantity].to_i
    
    item = Item.new(itemname: normalized_item, quantity: quantity)
    item.save
    redirect "/add?message=Added+#{quantity}+#{normalized_item}"
end

get '/batch' do
    require_login!
    erb :batch
end

post '/batch' do
    require_login!
    items = params[:batch_item] || []
    quantities = params[:batch_quantity] || []
    units = params[:batch_unit] || []
    normalized_items = items.map { |i| i.strip.upcase }
    normalized_quantities = quantities.map{|q| q.to_i}

    normalized_items.each_with_index do |item_name, idx|
      next if item_name.empty?
      
      qty = normalized_quantities[idx] || 0
      exist_item = Item.find_by(itemname: item_name)
      u = units[idx] || 0
      if exist_item
        exist_item.update(quantity: exist_item.quantity.to_i + qty, unit: exis_item.unit)
      else
        Item.create(itemname: item_name, quantity: qty, unit: u)
      end
  end
    redirect '/view?message=Batch+add+complete'
end

get '/edit/:itemname' do
    require_login!
    @item = Item.find_by(itemname: params[:itemname])
    if @item.nil?
      redirect '/view'
    else
      erb :edit
    end
end

get '/batch_edit' do
    require_login!
    selected = params[:selected_items] || []

    if selected.empty?
      redirect '/view'
    else
      @items = Item.where(itemname: selected)
      erb :batch_edit
    end
end

post '/edit/:itemname' do
    require_login!
    @item = Item.find_by(itemname: params[:itemname])
    if @item
      @item.update(quantity: params[:quantity].to_i)
      redirect "/view?message=Update+#{@item.itemname}+successfully."
    else
      redirect '/view?error=Item+not+found.'
    end
end

post '/delete/:itemname' do
    require_login!
    @item = Item.find_by(itemname: params[:itemname])
    if @item
      @item.destroy
      redirect "/view?message=Deleted+#{@item.itemname}+successfully."
    else
      redirect '/view?error=Item+not+found.'
    end
end

post '/batch_edit' do
    require_login!
    itemnames = params[:itemnames] || []
    new_quantities = params[:new_quantities] || []

    itemnames.zip(new_quantities).each do |name, qty|
      item = Item.find_by(itemname: name)
      item.update(quantity: qty) if item
  end

  redirect '/view?message=Batch+update+successfully.'
end

post '/batch_delete' do
  require_login!
  selected = params[:selected_items] || []
  if selected.any?
    selected.each do |name|
      item = Item.find_by(itemname: name)
      item.destroy()
    end
    redirect '/view?message=Batch+delete+successfully.'
  else
    redirect '/view?error=Selected+items+not+found.'
  end
end

get '/signup' do
    erb :signup
end

post '/signup' do
    username = params[:username].to_s
    password = params[:password].to_s
    if User.exists?(username: username)
        @signup_error = "Username already exists."
        erb :signup
    else
        user = User.create(username: username, password: password)
        if user.persisted?
            session[:user_id] = user.id
            redirect '/'
        else
            @signup_error = "Invalid username or password."
            erb :signup
        end
    end
end

get '/login' do
    erb :login
end

post '/login' do
    username = params[:username].to_s
    password = params[:password].to_s
    user = User.find_by(username: username)
    if user && user.authenticate(password)
        session[:user_id] = user.id
        redirect '/?message=Log+in+Successfully.'

    else
        @login_error = "Invalid username or password"
        erb :login
    end
end

get '/logout' do
    session.clear
    redirect '/?message=Log+out+Successfully.'
end
